trigger: none
name: 4.0.$(Rev:r)

pool:
  vmImage: ubuntu-latest

variables:
  WORK_PATH: "vm/path" # Path do diretório de VM ou VMSS
  ImageName: "image_name" # Nome da Imagem
  Environment: "mvx" # Identificação do Produto

stages:
  - stage: Development

    variables:
      - group: PACKER_DEV

    jobs:
      - job: Packer
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - template: ci-main.yml
            parameters:
              WORK_PATH: $(WORK_PATH)
              ManagedImagePrefix: "$(Environment)_DEV_$(ImageName)"
              PackerVarFile: "development.pkrvars.hcl"
              AzureResourceGroupTemplate: "rg-mvx-development-shared-eastus"
              TempAzureResouceGroup: "rg-mvx-development-shared-eastus"
              imageVersion: $(Build.BuildNumber)
              CLIENT_ID: $(CLIENT_ID)
              CLIENT_SECRET: $(CLIENT_SECRET)
              SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              TENANT_ID: $(TENANT_ID)

  - stage: Production

    variables:
      - group: PACKER_PROD

    jobs:
      - job: Packer
        pool:
          vmImage: "ubuntu-latest"
        steps:
          - template: ci-main.yml
            parameters:
              WORK_PATH: $(WORK_PATH)
              ManagedImagePrefix: "$(Environment)_PROD_$(ImageName)"
              PackerVarFile: "prod.pkrvars.hcl"
              AzureResourceGroupTemplate: "rg-mvx-prod-shared-eastus"
              TempAzureResouceGroup: "rg-mvx-prod-packer-temp"
              imageVersion: $(Build.BuildNumber)
              CLIENT_ID: $(CLIENT_ID)
              CLIENT_SECRET: $(CLIENT_SECRET)
              SUBSCRIPTION_ID: $(SUBSCRIPTION_ID)
              TENANT_ID: $(TENANT_ID)
