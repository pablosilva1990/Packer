parameters:
  - name: PACKER_RELEASE
    type: string 
    default: "1.8.5"
    
  - name: imageVersion
    type: string
    default: "1.0.0"
    displayName: Packer Managed Image Version

  - name: ManagedImagePrefix
    type: string
    default: mvx_prod_erp_$(version)
    displayName: Packer - Managed Image Prefix 

#  - name: AzureGalleryName
#    type: string
#    displayName:  Azure Compute  Galery

  - name: AzureResourceGroupTemplate
    type: string 
    displayName: Resource Group to store Images

  - name: TempAzureResouceGroup
    type: string 
    displayName: Temp Packer's Resource Group 

  - name: PackerVarFile
    type: string
    displayName: Packer's variables file

  - name: WORK_PATH
    type: string
    displayName: Path to Packer Module

# Azure Authentication
  - name: CLIENT_ID
    type: string
    displayName: CLIENT_ID
  - name: SUBSCRIPTION_ID
    type: string
    displayName: SUBSCRIPTION_ID
  - name: TENANT_ID
    type: string
    displayName: TENANT_ID
  - name: CLIENT_SECRET
    type: string
    displayName: CLIENT_SECRET
  
steps:

  - task: Bash@3
    inputs:
      targetType: "inline"
      script: |
        wget https://releases.hashicorp.com/packer/${{ parameters.PACKER_RELEASE }}/packer_${{ parameters.PACKER_RELEASE }}_linux_amd64.zip
        unzip packer_${{ parameters.PACKER_RELEASE }}_linux_amd64.zip
        sudo mv packer /usr/local/bin
    displayName: PACKER - INSTALL

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        ls -lR
    displayName: Checking - List Files

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        echo "MANAGED_IMAGE_PREFIX ${{ parameters.ManagedImagePrefix }}"
        echo "Image_version: ${{ parameters.imageVersion }}" 
        echo "AZURE_RESOURCE_GROUP_TEMPLATE: ${{ parameters.AzureResourceGroupTemplate}}"
        echo "Azure Authentication"
        echo "Client ID: ${{ parameters.CLIENT_ID }}"
        echo "Subscription ID: ${{ parameters.SUBSCRIPTION_ID }}"
        echo "Tenant ID: ${{ parameters.TENANT_ID }}"
    displayName: Checking - Variables

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        packer build -force  \
          -var-file="${{ parameters.PackerVarFile}}" \
          -var "build_resource_group_name=${{ parameters.TempAzureResouceGroup }}" \
          -var "managed_image_prefix=${{ parameters.ManagedImagePrefix }}" \
          -var "managed_image_resource_group_name=${{ parameters.AzureResourceGroupTemplate}}" \
          -var "image_version=${{ parameters.imageVersion }}" .
    env:
      PKR_VAR_client_id: ${{ parameters.CLIENT_ID }}
      PKR_VAR_client_secret: ${{ parameters.CLIENT_SECRET }}
      PKR_VAR_subscription_id: ${{ parameters.SUBSCRIPTION_ID }}
      PKR_VAR_tenant: ${{ parameters.TENANT_ID }}
    displayName: PACKER - BUILD
        
  # - ${{ each parameter in parameters.artifactsToPublish }}:
  #     - task: CopyFiles@2
  #       displayName: "Copy Files from ${{ parameter.Key }} to: $(Build.ArtifactStagingDirectory)"
  #       inputs:
  #         SourceFolder: ${{ parameter.value }}
  #         Contents: "**"
  #         TargetFolder: "$(Build.ArtifactStagingDirectory)/${{ parameter.Key }}"

  #     - publish: "$(Build.ArtifactStagingDirectory)/${{ parameter.Key }}"
  #       artifact: ${{ parameter.Key }}
  #       displayName: "Publish Artifact: ${{ parameter.Key }}"

  # - ${{ if eq(parameters.npm, true) }}:
  #     - task: Npm@1
  #       displayName: 'npm install'
  #       inputs:
  #         verbose: false
  # - ${{ each parameter in parameters.env }}:
  #     - task: Npm@1
  #       displayName: 'npm custom'
  #       inputs:
  #         command: custom
  #         verbose: false
  #         customCommand: 'run build -- --mode ${{ parameter.value }} --dest ${{ parameter.key }}'

  #     - task: CopyFiles@2
  #       displayName: 'Copy Files to: ${{ parameter.key }}'
  #       inputs:
  #         Contents: |
  #           web.config
  #           App.Release.config
  #         TargetFolder: ${{ parameter.key }}

  #     - task: CopyFiles@2
  #       displayName: 'Copy Files to: $(build.artifactstagingdirectory)'
  #       inputs:
  #         SourceFolder: ${{ parameter.key }}
  #         TargetFolder: '$(build.artifactstagingdirectory)/${{ parameter.key }}'

  #     - publish: "$(Build.ArtifactStagingDirectory)/${{ parameter.Key }}"
  #       artifact: ${{ parameter.Key }}
  #       displayName: "Publish Artifact: ${{ parameter.Key }}"

  # - ${{ if eq(parameters.console, true) }}:
  #     - powershell: |
  #         Write-Host "Build Console"
  #       displayName: 'Build Console'

  # - ${{ each parameter in parameters.SolutionPath }}:  
  #     - task: NuGetCommand@2
  #       displayName: "NuGet restore ${{ parameter.key }}"
  #       inputs:
  #         restoreSolution: ${{ parameter.value }}

  # - ${{ each parameter in parameters.csproj }}:  
  #     - task: CmdLine@1
  #       displayName: 'Run dotnet.exe - ${{ parameter.key }}'
  #       inputs:
  #         filename: dotnet.exe
  #         arguments: 'publish -c $(BuildConfiguration) -r win-x64 --self-contained $(SelfContained)'
  #         workingFolder: ${{ parameter.value }}

  # - ${{ each parameter in parameters.ConsoleArtifacts }}:
  #     - task: CopyFiles@2
  #       displayName: "Copy Files from ${{ parameter.Key }} to: $(Build.ArtifactStagingDirectory)"
  #       inputs:
  #         SourceFolder: ${{ parameter.value }}
  #         Contents: "**"
  #         TargetFolder: "$(Build.ArtifactStagingDirectory)/${{ parameter.Key }}"

  #     - publish: "$(Build.ArtifactStagingDirectory)/${{ parameter.Key }}"
  #       artifact: ${{ parameter.Key }}
  #       displayName: "Publish Artifact: ${{ parameter.Key }}"