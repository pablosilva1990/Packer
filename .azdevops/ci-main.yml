parameters:
  - name: PACKER_RELEASE
    type: string 
    default: "1.8.5"
    
  - name: imageVersion
    type: string
    default: "1.0.0"
    displayName: Packer Managed Image Version

  - name: ManagedImagePrefix
    type: string
    displayName: Packer - Managed Image Prefix 

  - name: AzureResourceGroupTemplate
    type: string 
    displayName: Resource Group to store Images

  - name: TempAzureResouceGroup
    type: string 
    displayName: Temp Packer's Resource Group 

  - name: PackerVarFile
    type: string
    displayName: Packer's variables file

  - name: WORK_PATH
    type: string
    displayName: Path to Packer Module

# Azure Authentication
  - name: CLIENT_ID
    type: string
    displayName: CLIENT_ID
  - name: SUBSCRIPTION_ID
    type: string
    displayName: SUBSCRIPTION_ID
  - name: TENANT_ID
    type: string
    displayName: TENANT_ID
  - name: CLIENT_SECRET
    type: string
    displayName: CLIENT_SECRET
  
steps:

  - task: Bash@3
    inputs:
      targetType: "inline"
      script: |
        wget https://releases.hashicorp.com/packer/${{ parameters.PACKER_RELEASE }}/packer_${{ parameters.PACKER_RELEASE }}_linux_amd64.zip
        unzip packer_${{ parameters.PACKER_RELEASE }}_linux_amd64.zip
        sudo mv packer /usr/local/bin
    displayName: PACKER - INSTALL

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        ls -lR
    displayName: Checking - List Files

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        echo "MANAGED_IMAGE_PREFIX ${{ parameters.ManagedImagePrefix }}"
        echo "Image_version: ${{ parameters.imageVersion }}" 
        echo "AZURE_RESOURCE_GROUP_TEMPLATE: ${{ parameters.AzureResourceGroupTemplate}}"
        echo "Azure Authentication"
        echo "Client ID: ${{ parameters.CLIENT_ID }}"
        echo "Subscription ID: ${{ parameters.SUBSCRIPTION_ID }}"
        echo "Tenant ID: ${{ parameters.TENANT_ID }}"
    displayName: Checking - Variables

  - task: Bash@3
    inputs:
      workingDirectory: ${{ parameters.WORK_PATH }}
      targetType: "inline"
      script: |
        packer build -force  \
          -var-file="${{ parameters.PackerVarFile}}" \
          -var "build_resource_group_name=${{ parameters.TempAzureResouceGroup }}" \
          -var "managed_image_prefix=${{ parameters.ManagedImagePrefix }}" \
          -var "managed_image_resource_group_name=${{ parameters.AzureResourceGroupTemplate}}" \
          -var "image_version=${{ parameters.imageVersion }}" .
    env:
      PKR_VAR_client_id: ${{ parameters.CLIENT_ID }}
      PKR_VAR_client_secret: ${{ parameters.CLIENT_SECRET }}
      PKR_VAR_subscription_id: ${{ parameters.SUBSCRIPTION_ID }}
      PKR_VAR_tenant: ${{ parameters.TENANT_ID }}
    displayName: PACKER - BUILD