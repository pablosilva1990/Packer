- name: Setup and Update Config on NGINX
  hosts: default
  become: True
  tags: nginx
  vars:
    - envbuilder_path: "../../../../EnvBuilder/"

  tasks:
    - name: Install Nginx
      apt: 
        name: nginx 
        state: present

    - name: Create directories for ssl certificates
      file: 
        path: /etc/ssl/certs/mvx/
        owner: root
        group: root
        state: directory
        mode: '0600'
    
    - name: copy TLS certificate
      copy:
        src: "{{ envbuilder_path }}files/microvix-chained.crt"
        dest: /etc/ssl/certs/mvx/microvix-chained.crt
        owner: root 
        mode: '0600'

    - name: copy TLS key
      copy: 
        src: "{{ envbuilder_path }}files/microvix.key"
        dest: /etc/ssl/certs/mvx/microvix.key
        owner: root 
        mode: '0600'

    - name: copy nginx config file
      template: 
        src: "{{ envbuilder_path }}templates/nginx.conf.j2"
        dest: /etc/nginx/nginx.conf

    - name: copy default site config file
      template: 
        src: "{{ envbuilder_path }}templates/sites/site-default.conf.j2"
        dest: /etc/nginx/sites-available/default.conf

    - name: Copy Site WEBAPI - Microvix
      template: 
        src: "{{ envbuilder_path }}templates/sites/webapi.microvix.com.br.conf.j2"
        dest: /etc/nginx/sites-available/webapi.microvix.com.br.conf

    - name: enable configuration
      file: 
        src: /etc/nginx/sites-available/webapi.microvix.com.br.conf
        dest: /etc/nginx/sites-enabled/webapi.microvix.com.br.conf 
        state: link

    - name: Create directories for conf.d
      file: 
        path: /etc/nginx/conf.d/
        owner: root
        group: root
        state: directory
        mode: '0600'

    - name: copy logformat config file
      copy:
        src: "{{ envbuilder_path }}templates/conf.d/logformat.conf.j2"
        dest: "/etc/nginx/conf.d/logformat.conf"

    # A task de upstream deve ser executada na VM criada
    # Motivo: A upstream utiliza resolução de nomes de DNS privados, que só serão resolvidos quando a máquina possuir comunicação com um DNS Server
     
    # - name: copy upstream config file
    #   copy:
    #     src: "{{ envbuilder_path }}templates/conf.d/upstream.conf.j2"
    #     dest: /etc/nginx/conf.d/upstream.conf
        
    - name: copy useragent rules file
      copy:
        src: "{{ envbuilder_path }}templates/conf.d/useragent-rules.conf.j2"
        dest: /etc/nginx/conf.d/useragent-rules.conf

    - name: copy limits zone file
      copy:
        src: "{{ envbuilder_path }}templates/conf.d/limits_zone.conf.j2"
        dest: /etc/nginx/conf.d/limits_zone.conf

    - name: "Add Cronjob - Clean logs of Nginx"
      cron:
        name: "Clean logs of Nginx"
        state: present
        minute: "0"
        hour: "5"
        day: "*"
        month: "*"
        weekday: "*"
        job: 'find /var/log/nginx/*.gz -mtime +14 -delete'
    
    - name: Setup file log rotate Nginx
      copy:
        src: "{{ envbuilder_path }}templates/logrotate.d/nginx-json.j2"
        dest: /etc/logrotate.d/nginx-json

    - name: "Add Cronjob - Log Rotate Json"
      cron:
        name: "Log Rotate - Logs Json"
        state: present
        minute: "0"
        hour: "*/2"
        day: "*"
        month: "*"
        weekday: "*"
        job: 'logrotate -f /etc/logrotate.d/nginx-json'

    - name: Start Nginx
      service:
          name: nginx
          state: started

    - name: nginx -t && nginx -s reload
      shell: nginx -t && nginx -s reload
      register: nginx_test_result

    - debug:
        var: nginx_test_result.stdout_lines